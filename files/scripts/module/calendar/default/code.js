"/*\n * Module: calendar\n *\n * Example of custom_module require:\n *\n * var calendar = require('/custom_modules/calendar');\n *\n */\n\nvar async = require('async');\n\n\n\nexports.updateEntryRating = function(corus, calendar_entry, callback){\n\n    async.waterfall(\n        [\n            function(icallback){\n                \n                var ratings_filter = {\n                        where: \t\t{\n                            parent: calendar_entry\n                        },\n                        limit:\t\t1000000000,\n                        count:\t\tfalse\n\t                };\n\n                // Cerquem els ratings de l'apunt del calendari\n                corus.apps(process.env.APP).collections('calendar_entries_rating').data().get(ratings_filter, function(err, result){\n                    icallback(err, result.array);\n                });\n\n            },\n            function(rating_results, icallback){\n\n                var average = 0,\n                    total = 0;\n\n                if (rating_results && rating_results.length > 0){\n                    \n                    rating_results.forEach(function(vote){\n                        total = total + parseInt(vote.rating, 10);\n                    });\n\n                    average = total / rating_results.length;\n                    \n                }\n\n                icallback(null, average, rating_results.length);\n\n            },\n            function(average, total_votes, icallback){\n\n                // Guardem el promig\n                corus.apps(process.env.APP).collections('calendar_entries').data(calendar_entry).put({ average_rating: average, total_votes: total_votes }, function(err, item){\n\t\t\t\t\ticallback(err, average, total_votes);\n                });\n\n            }\n        ],\n        function(error, average, total_votes){\n            \n            if (callback && typeof(callback) === 'function'){\n\t            callback(error, average, total_votes);\n            }\n\n        }\n    );\n\n};"
